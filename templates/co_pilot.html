<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research Co-Pilot 🚀</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 3.5rem;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            background: linear-gradient(45deg, #fff, #f0f0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.3rem;
            opacity: 0.95;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .workflow-container {
            background: white;
            border-radius: 25px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .step {
            padding: 35px;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.4s ease;
            position: relative;
        }

        .step:last-child {
            border-bottom: none;
        }

        .step.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.02);
        }

        .step.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3);
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
        }

        .step-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            margin-right: 20px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .step.active .step-number {
            background: white;
            color: #667eea;
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.4);
        }

        .step-title {
            font-size: 1.8rem;
            font-weight: 600;
        }

        .step-content {
            display: none;
        }

        .step.active .step-content {
            display: block;
            animation: fadeInUp 0.5s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .form-control {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 15px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .research-questions {
            background: #ffffff;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            border: 2px solid #e9ecef;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .research-questions h4 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .research-question {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 5px solid #667eea;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
            color: #333;
            font-weight: 500;
            line-height: 1.5;
        }

        .research-question:hover {
            transform: translateX(5px);
            background: #e9ecef;
        }

        .paper-suggestions {
            background: #ffffff;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            border: 2px solid #e9ecef;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .paper-suggestions h4 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .paper-suggestions pre {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
            white-space: pre-wrap;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            color: #333;
            overflow-x: auto;
            margin-top: 15px;
        }

        .methodology-suggestions {
            background: #ffffff;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            border: 2px solid #e9ecef;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .methodology-suggestions h4 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .methodology-suggestions pre {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
            white-space: pre-wrap;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            color: #333;
            overflow-x: auto;
            margin-top: 15px;
        }

        .draft-preview {
            background: #ffffff;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            border: 2px solid #e9ecef;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            line-height: 1.5;
            color: #333;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            font-size: 14px;
        }

        .draft-preview h4 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .draft-preview pre {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            color: #333;
            overflow-x: auto;
            margin-top: 15px;
        }

        .final-paper {
            background: #ffffff;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            border: 2px solid #e9ecef;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            line-height: 1.5;
            color: #333;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            font-size: 14px;
        }

        .final-paper h4 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .final-paper pre {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            color: #333;
            overflow-x: auto;
            margin-top: 15px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 25px 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            border: 2px solid #e1e5e9;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            color: #333;
            font-weight: 500;
        }

        .checkbox-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
            background: #f8f9fa;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .checkbox-item label {
            color: #333;
            font-weight: 500;
            cursor: pointer;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e1e5e9;
            border-radius: 6px;
            margin: 25px 0;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.8s ease;
            border-radius: 6px;
        }

        .status {
            text-align: center;
            padding: 25px;
            background: #e8f5e8;
            border-radius: 15px;
            margin: 25px 0;
            color: #155724;
            border: 2px solid #c3e6cb;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .download-section {
            text-align: center;
            padding: 40px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 20px;
            margin: 25px 0;
            border: 2px solid #dee2e6;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .download-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.8rem;
        }

        .download-section p {
            color: #666;
            margin-bottom: 25px;
            font-size: 1.1rem;
        }

        .download-buttons {
            display: flex;
            justify-content: center;
            gap: 25px;
            flex-wrap: wrap;
            margin-top: 25px;
        }

        .download-buttons .btn {
            min-width: 200px;
            font-size: 1.1rem;
            padding: 18px 30px;
        }

        .compilation-status.info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }

        .paper-content-display {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            border: 2px solid #e9ecef;
            max-height: 600px;
            overflow-y: auto;
        }

        .paper-content-display h4 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .paper-content-display pre {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            color: #333;
            overflow-x: auto;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }
            
            .step {
                padding: 25px;
            }
            
            .download-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .download-buttons .btn {
                min-width: 100%;
            }
        }

        .step.active .step-content p {
            color: #ffffff;
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .step.active .step-content h4 {
            color: #ffffff;
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .step.active .step-content .form-group label {
            color: #ffffff;
        }

        .step.active .step-content .checkbox-item {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
            color: #ffffff;
        }

        .step.active .step-content .checkbox-item label {
            color: #ffffff;
        }

        .step.active .step-content .checkbox-item:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 Research Co-Pilot</h1>
            <p>Your AI-powered research brainstorming assistant</p>
        </div>

        <div class="workflow-container">
            <!-- Step 1: Topic Refinement -->
            <div class="step active" id="step1">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <div class="step-title">Topic Refinement</div>
                </div>
                <div class="step-content">
                    <p>Let's start by refining your broad research topic into specific, focused research questions.</p>
                    
                    <div class="form-group">
                        <label for="broadTopic">Enter your broad research topic:</label>
                        <input type="text" id="broadTopic" class="form-control" placeholder="e.g., machine learning in healthcare, quantum computing applications, sustainable energy solutions">
                    </div>
                    
                    <button class="btn" onclick="refineTopic()">🔍 Refine Topic</button>
                    
                    <div id="topicResults" style="display: none;">
                        <div class="research-questions" id="researchQuestions"></div>
                        <div id="clarifyingQuestions"></div>
                        <button class="btn btn-success" onclick="nextStep(2)">Continue to Literature Review →</button>
                    </div>
                </div>
            </div>

            <!-- Step 2: Literature Review -->
            <div class="step" id="step2">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <div class="step-title">Literature Review</div>
                </div>
                <div class="step-content">
                    <p>Now let's identify relevant papers and literature for your research.</p>
                    
                    <div id="paperSuggestions" class="paper-suggestions" style="display: none;"></div>
                    
                    <div id="paperSelection" style="display: none;">
                        <p>Select 3-5 papers you want to focus on:</p>
                        <div class="checkbox-group" id="paperCheckboxes"></div>
                        <button class="btn btn-success" onclick="nextStep(3)">Continue to Methodology →</button>
                    </div>
                </div>
            </div>

            <!-- Step 3: Methodology Design -->
            <div class="step" id="step3">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <div class="step-title">Methodology Design</div>
                </div>
                <div class="step-content">
                    <p>Let's design your research methodology and experimental approach.</p>
                    
                    <div id="methodologySuggestions" class="methodology-suggestions" style="display: none;"></div>
                    
                    <div id="methodologyPreferences" style="display: none;">
                        <p>Please answer these methodology preference questions:</p>
                        <div id="methodologyQuestions"></div>
                        <button class="btn btn-success" onclick="nextStep(4)">Continue to Draft Generation →</button>
                    </div>
                </div>
            </div>

            <!-- Step 4: Draft Generation -->
            <div class="step" id="step4">
                <div class="step-header">
                    <div class="step-number">4</div>
                    <div class="step-title">Draft Generation</div>
                </div>
                <div class="step-content">
                    <p>Now let's generate a LaTeX draft skeleton for your research paper.</p>
                    
                    <button class="btn" onclick="generateDraft()">✍️ Generate Draft</button>
                    
                    <div id="draftPreview" class="draft-preview" style="display: none;"></div>
                    
                    <div id="draftActions" style="display: none;">
                        <button class="btn btn-success" onclick="nextStep(5)">Continue to Polish →</button>
                    </div>
                </div>
            </div>

            <!-- Step 5: Polish and Finalize -->
            <div class="step" id="step5">
                <div class="step-header">
                    <div class="step-number">5</div>
                    <div class="step-title">Polish and Finalize</div>
                </div>
                <div class="step-content">
                    <p>Finally, let's polish your paper to ensure academic quality and proper formatting.</p>
                    
                    <button class="btn" onclick="polishPaper()">✨ Polish Paper</button>
                    
                    <div id="finalPaper" class="final-paper" style="display: none;"></div>
                    
                    <div id="downloadSection" class="download-section" style="display: none;">
                        <h3>🎉 Your Research Paper is Ready!</h3>
                        <p>Download your completed research paper in LaTeX format:</p>
                        <div class="download-buttons">
                            <button class="btn btn-success" onclick="downloadPaper('tex')">📄 Download LaTeX (.tex)</button>
                        </div>
                        
                        <div class="compilation-status info" style="display: block; margin-top: 25px;">
                            <strong>💡 Note:</strong> The LaTeX file can be compiled to PDF manually using:
                            <br><code>pdflatex filename.tex</code>
                            <br>Or use online LaTeX editors like Overleaf, TeXstudio, or TeXmaker.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="status" id="status" style="display: none;"></div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Processing...</p>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let researchData = {};

        // Initialize the system
        window.onload = function() {
            initializeSystem();
        };

        async function initializeSystem() {
            showLoading(true);
            showStatus('Initializing Research Co-Pilot...', 'status');
            
            try {
                const response = await fetch('/api/initialize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showStatus(data.message, 'status');
                    setTimeout(() => hideStatus(), 3000);
                } else {
                    showStatus('Failed to initialize: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function refineTopic() {
            const topic = document.getElementById('broadTopic').value.trim();
            if (!topic) {
                showStatus('Please enter a research topic', 'error');
                return;
            }

            showLoading(true);
            showStatus('Refining your research topic...', 'status');

            try {
                const response = await fetch('/api/step1_topic', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic: topic })
                });

                const data = await response.json();

                if (data.success) {
                    researchData.topic = topic;
                    researchData.researchQuestions = data.research_questions;
                    researchData.clarifyingQuestions = data.clarifying_questions;
                    researchData.analysis = data.analysis;

                    displayTopicResults(data);
                    showStatus('Topic refined successfully!', 'status');
                    setTimeout(() => hideStatus(), 3000);
                } else {
                    showStatus('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function displayTopicResults(data) {
            // Display research questions
            const questionsDiv = document.getElementById('researchQuestions');
            questionsDiv.innerHTML = '<h4>Generated Research Questions:</h4>';
            data.research_questions.forEach((q, i) => {
                questionsDiv.innerHTML += `<div class="research-question">${i + 1}. ${q}</div>`;
            });

            // Display clarifying questions
            const clarifyingDiv = document.getElementById('clarifyingQuestions');
            clarifyingDiv.innerHTML = '<h4>Please answer these clarifying questions:</h4>';
            data.clarifying_questions.forEach((q, i) => {
                clarifyingDiv.innerHTML += `
                    <div class="form-group">
                        <label>${i + 1}. ${q}</label>
                        <input type="text" class="form-control" id="clarifying_${i}" placeholder="Your answer">
                    </div>
                `;
            });

            document.getElementById('topicResults').style.display = 'block';
        }

        async function nextStep(step) {
            if (step === 2) {
                // Collect clarifying responses
                const responses = {};
                researchData.clarifyingQuestions.forEach((q, i) => {
                    const input = document.getElementById(`clarifying_${i}`);
                    responses[`q${i + 1}`] = input.value.trim();
                });

                researchData.clarifyingResponses = responses;
                await runLiteratureReview();
            } else if (step === 3) {
                await runMethodologyDesign();
            } else if (step === 4) {
                await runDraftGeneration();
            } else if (step === 5) {
                await runPolishPaper();
            }

            setActiveStep(step);
            updateProgress();
        }

        async function runLiteratureReview() {
            showLoading(true);
            showStatus('Researching relevant papers...', 'status');

            try {
                const response = await fetch('/api/step2_literature', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        clarifying_responses: researchData.clarifyingResponses 
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayPaperSuggestions(data.paper_suggestions);
                    showStatus('Literature review completed!', 'status');
                    setTimeout(() => hideStatus(), 3000);
                } else {
                    showStatus('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function displayPaperSuggestions(suggestions) {
            const suggestionsDiv = document.getElementById('paperSuggestions');
            suggestionsDiv.innerHTML = '<h4>📚 Paper Suggestions:</h4><pre>' + suggestions + '</pre>';
            suggestionsDiv.style.display = 'block';

            // Create paper selection checkboxes
            const checkboxesDiv = document.getElementById('paperCheckboxes');
            checkboxesDiv.innerHTML = '';
            for (let i = 1; i <= 8; i++) {
                checkboxesDiv.innerHTML += `
                    <div class="checkbox-item">
                        <input type="checkbox" id="paper_${i}" value="${i-1}">
                        <label for="paper_${i}">Paper ${i}</label>
                    </div>
                `;
            }

            document.getElementById('paperSelection').style.display = 'block';
        }

        async function runMethodologyDesign() {
            // Collect selected papers
            const selectedPapers = [];
            for (let i = 1; i <= 8; i++) {
                const checkbox = document.getElementById(`paper_${i}`);
                if (checkbox.checked) {
                    selectedPapers.push(parseInt(checkbox.value));
                }
            }

            if (selectedPapers.length === 0) {
                showStatus('Please select at least one paper', 'error');
                return;
            }

            researchData.selectedPapers = selectedPapers;

            showLoading(true);
            showStatus('Designing methodology...', 'status');

            try {
                const response = await fetch('/api/step3_methodology', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ selected_papers: selectedPapers })
                });

                const data = await response.json();

                if (data.success) {
                    displayMethodologySuggestions(data.methodology_suggestions);
                    showStatus('Methodology design completed!', 'status');
                    setTimeout(() => hideStatus(), 3000);
                } else {
                    showStatus('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function displayMethodologySuggestions(suggestions) {
            const suggestionsDiv = document.getElementById('methodologySuggestions');
            suggestionsDiv.innerHTML = '<h4>🔬 Methodology Suggestions:</h4><pre>' + suggestions + '</pre>';
            suggestionsDiv.style.display = 'block';

            // Create methodology preference questions
            const questionsDiv = document.getElementById('methodologyQuestions');
            const questions = [
                'What is your preferred experiment scale? (small/medium/large)',
                'What type of experiments do you prefer? (empirical/theoretical/hybrid)',
                'What are your computational resource constraints?',
                'Do you have access to specific datasets?',
                'What is your timeline for experiments?'
            ];

            questionsDiv.innerHTML = '';
            questions.forEach((q, i) => {
                questionsDiv.innerHTML += `
                    <div class="form-group">
                        <label>${i + 1}. ${q}</label>
                        <input type="text" class="form-control" id="methodology_${i}" placeholder="Your answer">
                    </div>
                `;
            });

            document.getElementById('methodologyPreferences').style.display = 'block';
        }

        async function runDraftGeneration() {
            // Collect methodology preferences
            const preferences = {};
            for (let i = 0; i < 5; i++) {
                const input = document.getElementById(`methodology_${i}`);
                preferences[`pref_${i + 1}`] = input.value.trim();
            }

            researchData.methodologyPreferences = preferences;

            showLoading(true);
            showStatus('Generating LaTeX draft...', 'status');

            try {
                const response = await fetch('/api/step4_draft', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ methodology_preferences: preferences })
                });

                const data = await response.json();

                if (data.success) {
                    displayDraftPreview(data.draft_skeleton);
                    showStatus('Draft generation completed!', 'status');
                    setTimeout(() => hideStatus(), 3000);
                } else {
                    showStatus('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function displayDraftPreview(draft) {
            const previewDiv = document.getElementById('draftPreview');
            previewDiv.innerHTML = '<h4>✍️ LaTeX Draft Preview:</h4><pre>' + draft + '</pre>';
            previewDiv.style.display = 'block';

            document.getElementById('draftActions').style.display = 'block';
        }

        async function runPolishPaper() {
            showLoading(true);
            showStatus('Polishing your paper...', 'status');

            try {
                const response = await fetch('/api/step5_polish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    displayFinalPaper(data.final_paper);
                    showStatus('Paper polishing completed!', 'status');
                    setTimeout(() => hideStatus(), 3000);
                } else {
                    showStatus('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function displayFinalPaper(paper) {
            const finalDiv = document.getElementById('finalPaper');
            finalDiv.innerHTML = '<h4>✨ Final Polished Paper:</h4><pre>' + paper + '</pre>';
            finalDiv.style.display = 'block';

            document.getElementById('downloadSection').style.display = 'block';
        }

        async function downloadPaper(type) {
            try {
                const response = await fetch('/api/download_paper', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'tex' })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = response.headers.get('content-disposition')?.split('filename=')[1] || `research_paper.tex`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showStatus('✅ LaTeX file downloaded successfully!', 'status');
                    setTimeout(() => hideStatus(), 3000);
                } else {
                    const data = await response.json();
                    showStatus('Download failed: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('Download error: ' + error.message, 'error');
            }
        }

        function setActiveStep(step) {
            // Remove active class from all steps
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            
            // Add active class to current step
            document.getElementById(`step${step}`).classList.add('active');
            
            currentStep = step;
        }

        function updateProgress() {
            const progress = (currentStep / 5) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
        }

        function hideStatus() {
            document.getElementById('status').style.display = 'none';
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
    </script>
</body>
</html>
